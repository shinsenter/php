#!/usr/bin/env sh
################################################################################
#     These setups are part of the project: https://code.shin.company/php
#     Please respect the intellectual effort that went into creating them.
#     If you use or copy these ideas, proper credit would be appreciated.
#      - Author:  SHIN Company <shin@shin.company>
#      - License: https://code.shin.company/php/blob/main/LICENSE
################################################################################

conf_path="${ENV:=/etc/.docker-env}"

# correct path for the container
if [ ! -f $conf_path ]; then
    mkdir -p "$(dirname $conf_path)"
    echo '#!/bin/sh
APP_PATH="$(app-path)"
APP_ROOT="$(app-root)"
if [ -d "$APP_PATH" ]; then cd "$APP_PATH"; fi

NEW_PATH="$(echo $PATH | sed "s/\/usr\/local\/aliases://")"
if [ ! -z "$COMPOSER_HOME" ] && ! echo $NEW_PATH | grep -qF "$COMPOSER_HOME/vendor/bin"; then NEW_PATH="$COMPOSER_HOME/vendor/bin:$NEW_PATH"; fi
if ! echo $NEW_PATH | grep -qF "$APP_PATH/vendor/bin"; then NEW_PATH="$APP_PATH/vendor/bin:$NEW_PATH"; fi
export PATH="$NEW_PATH"

' >$conf_path
    chmod +x $conf_path
fi

# print the environment variables when the command argument is empty
if [ $# -eq 0 ]; then with-env; exit 0; fi

# if the first argument is a file then use it
if [ "${1:0:1}" = "/" ] && [ -f "$1" ]; then
    # check if the file is already sourced
    if ! grep -qF "source $1" $conf_path; then
        echo "\nsource $1\n" >>$conf_path
    fi

    # use the first argument as the config file
    conf_path="$1"

    shift
fi

line="$@"

# add a comment if the command argument starts with #
if [ "${line:0:1}" = "#" ]; then
    echo -e "\n${line}\n# ------------------------------------------------------------ #" >>$conf_path
    exit
fi

# add a bash alias
if [ "${line:0:6}" = "alias " ]; then
    echo "$line" >>$conf_path
    exit
fi

# add an environment variable
name="$1"; shift
set -- "$(echo "$@" | sed -e 's/\([\\"]\)/\\\1/g')"
sed -i "/$name=/d" $conf_path &>/dev/null
echo "if [ -z \${${name}+x} ]; then export $name=\"$@\"; fi" >>$conf_path
