#!/usr/bin/env sh
################################################################################
#     These setups are part of the project: https://code.shin.company/php
#     Please respect the intellectual effort that went into creating them.
#     If you use or copy these ideas, proper credit would be appreciated.
#      - Author:  SHIN Company <shin@shin.company>
#      - License: https://code.shin.company/php/blob/main/LICENSE
################################################################################

conf_path="${ENV:-/etc/.docker-env}"

if [[ ! -f "$conf_path" ]]; then
    mkdir -p "$(dirname $conf_path)"

    cat <<'EOSH' > "$conf_path"
#!/bin/sh
APP_PATH="$(app-path)"
[ -d "$APP_PATH" ] && cd "$APP_PATH"

PATH="${PATH#/usr/local/aliases:}"

[ -n "$COMPOSER_HOME" ] && case ":$PATH:" in
    *":$COMPOSER_HOME/vendor/bin:"*) ;;
    *) PATH="$COMPOSER_HOME/vendor/bin:$PATH" ;;
esac

case ":$PATH:" in
    *":$APP_PATH/vendor/bin:"*) ;;
    *) PATH="$APP_PATH/vendor/bin:$PATH" ;;
esac

export PATH
EOSH

    chmod +x "$conf_path"
fi

# print the environment variables when the command argument is empty
if [ $# -eq 0 ]; then with-env; exit 0; fi

# if the first argument is a file then use it
if [ "${1:0:1}" = "/" ] && [ -f "$1" ]; then
    # check if the file is already sourced
    if ! grep -qF "source $1" $conf_path; then
        echo "\nsource $1\n" >>"$conf_path"
    fi

    # use the first argument as the config file
    conf_path="$1"

    shift
fi

line="$@"

# add a comment if the command argument starts with #
if [ "${line:0:1}" = "#" ]; then
    hl='# --------------------------------------------'
    echo -e "\n${hl}\n${line}\n${hl}" >>"$conf_path"
    exit
fi

# add a bash alias
if [ "${line:0:6}" = "alias " ]; then
    echo "$line" >>"$conf_path"
    exit
fi

# add an environment variable
name="$1"; shift
set -- "$(echo "$@" | sed -e 's/\([\\"]\)/\\\1/g')"

# minlen=48
# check="if [ -z \${${name}+x} ];"
# newline="$(printf "%s%*s%s\n" "$check" $(( $minlen - ${#check} > 0 ? $minlen - ${#check} : 1 )) "" "then export $name=\"$@\"; fi")"
# if grep -qF "$name=" "$conf_path"; then
#     sed -i "/$name=/c\\$newline" "$conf_path"
# else
#     echo "$newline" >>"$conf_path"
# fi

newline="export $name=\"\${$name:=\"$@\"}\""
if grep -qF "export $name=" "$conf_path"; then
    sed -i "/export $name=/c\\$newline" "$conf_path"
else
    echo "$newline" >>"$conf_path"
fi
