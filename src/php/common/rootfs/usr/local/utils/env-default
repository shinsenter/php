#!/usr/bin/env sh
################################################################################
#     These setups are part of the project: https://code.shin.company/php
#     Please respect the intellectual effort that went into creating them.
#     If you use or copy these ideas, proper credit would be appreciated.
#      - Author:  Mai Nhut Tan <shin@shin.company>
#      - License: https://code.shin.company/php/blob/main/LICENSE
################################################################################
conf_path="$(env-path)"

if [ ! -f "$conf_path" ]; then
    mkdir -p "$(dirname $conf_path)"
    cat <<'ENVVARS' > "$conf_path"
#!/bin/sh
APP_PATH="$(app-path)"
APP_ROOT="$(app-root)"
PATH="${PATH#/usr/local/aliases:}"
add_to_path() {
    dir="${1%/}"
    if [ -n "$dir" ] && [[ ":$PATH:" != *":$dir:"* ]]; then PATH="${dir}${PATH:+:}${PATH}"; fi
}
required_paths=(
/bin /sbin
/usr/bin /usr/sbin
/usr/local/bin /usr/local/sbin
/usr/local/utils
"$(composer global config bin-dir --quiet --absolute 2>/dev/null)"
"$(composer -d $APP_PATH config bin-dir --quiet --absolute 2>/dev/null)"
)
for dir in "${required_paths[@]}"; do add_to_path "$dir"; done

export PATH APP_PATH APP_ROOT
web-mkdir "$APP_PATH" && cd "$APP_PATH" &>/dev/null || true

# begin extra sources
# end extra sources
ENVVARS
    chmod +x "$conf_path"
fi

# print the environment variables when the command argument is empty
if [ "$#" -eq 0 ]; then with-env; exit 0; fi

# if the first argument is a file then use it
if [ "${1:0:1}" = "/" ] && [ -f "$1" ]; then
    # check if the file is already sourced
    if ! grep -qF -- "source $1" $conf_path; then
        sed -i "/# end extra sources/i source $1" "$conf_path"
    fi

    # use the first argument as the config file
    conf_path="$1"
    shift
fi

line="$@"

# add a comment if the command argument starts with #
if [ "${line:0:1}" = "#" ]; then
    if ! grep -qF -- "$line" "$conf_path"; then
        hl='# --------------------------------------------'
        echo -e "\n${hl}\n${line}\n${hl}" >>"$conf_path"
    fi
    exit 0
fi

# add a bash alias
if [ "${line:0:6}" = "alias " ]; then
    echo "$line" >>"$conf_path"
    exit 0
fi

# add an environment variable
name="$1"; shift
set -- "$(echo "$@" | sed -e 's/\([\\"]\)/\\\1/g')"

newline="export $name=\"\${$name:=\"$@\"}\""
if grep -qF -- "export $name=" "$conf_path"; then
    sed -i "/export $name=/c\\$newline" "$conf_path"
else
    echo "$newline" >>"$conf_path"
fi
