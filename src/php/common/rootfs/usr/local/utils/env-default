#!/usr/bin/env sh
################################################################################
#     These setups are part of the project: https://code.shin.company/php
#     Please respect the intellectual effort that went into creating them.
#     If you use or copy these ideas, proper credit would be appreciated.
#      - Author:  Mai Nhut Tan <shin@shin.company>
#      - License: https://code.shin.company/php/blob/main/LICENSE
################################################################################
conf_path="$(env-path)"

if [ ! -f "$conf_path" ]; then
    mkdir -p "$(dirname $conf_path)"
    cat <<'ENVVARS' > "$conf_path"
#!/usr/bin/env sh
[ "$TERM" = "dumb" ] && export TERM=xterm
PATH=$(echo "$PATH" | sed -E 's#(^|:)/usr/local/aliases(:|$)#\1\2#g; s#^:##; s#:$##; s#::#:#g')
composer_bin() { [ -n "$(type -P composer)" ] && composer "$@" config bin-dir --quiet --absolute 2>/dev/null; }
add_to_path()  { dir="${1%/}"; [ -n "$dir" ] && [[ ":$PATH:" != *":$dir:"* ]] && PATH="${dir}${PATH:+:}${PATH}"; }
for dir in /{bin,sbin} /usr/{bin,sbin} /usr/local/{bin,sbin,utils}; do add_to_path "$dir"; done

APP_PATH="$(app-path)"
APP_ROOT="$(app-root)"

web-mkdir "$APP_PATH" && cd "$APP_PATH" &>/dev/null || true
add_to_path "$(composer_bin global)"
add_to_path "$(composer_bin -d "$APP_PATH")"

export PATH APP_PATH APP_ROOT

# begin extra sources
# end extra sources
ENVVARS
    chmod +x "$conf_path"
fi

# print the environment variables when the command argument is empty
if [ "$#" -eq 0 ]; then with-env; exit 0; fi

# if the first argument is a file then use it
if [ "${1:0:1}" = "/" ] && [ -f "$1" ]; then
    # check if the file is already sourced
    if ! grep -qF -- "source $1" $conf_path; then
        sed -i "/# end extra sources/i source $1" "$conf_path"
    fi

    # use the first argument as the config file
    conf_path="$1"
    shift
fi

line="$@"

# add a comment if the command argument starts with #
if [ "${line:0:1}" = "#" ]; then
    if ! grep -qF -- "$line" "$conf_path"; then
        hl='# --------------------------------------------'
        echo -e "\n${hl}\n${line}\n${hl}" >>"$conf_path"
    fi
    exit 0
fi

# add a bash alias
if [ "${line:0:6}" = "alias " ]; then
    echo "$line" >>"$conf_path"
    exit 0
fi

# add an environment variable
name="$1"; shift
set -- "$(echo "$@" | sed -e 's/\([\\"]\)/\\\1/g')"

newline="export $name=\"\${$name:=\"$@\"}\""
if grep -qF -- "export $name=" "$conf_path"; then
    sed -i "/export $name=/c\\$newline" "$conf_path"
else
    echo "$newline" >>"$conf_path"
fi
