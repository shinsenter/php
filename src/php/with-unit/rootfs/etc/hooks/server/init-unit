#!/usr/bin/env sh
################################################################################
#     These setups are part of the project: https://code.shin.company/php
#     Please respect the intellectual effort that went into creating them.
#     If you use or copy these ideas, proper credit would be appreciated.
#      - Author:  SHIN Company <shin@shin.company>
#      - License: https://code.shin.company/php/blob/main/LICENSE
################################################################################
unit_socket="${UNIT_CONTROL_SOCKET:-/run/control.unit.sock}"
unit_pid_file="${UNIT_CONTROL_PID:-/run/unit.pid}"

if is-debug && has-cmd unitd-debug; then
    unitd_bin="$(command -v unitd-debug)"
else
    unitd_bin="$(command -v unitd)"
fi

if ! is-true "${DISABLE_GREETING:-}" && [[ -x "$unitd_bin" ]]; then
    "$unitd_bin" --version 2>&1 | grep version || true
fi

configtest() {
    download -X GET --unix-socket "$unit_socket" http://localhost/ || true
}

export -f configtest

init_unit() {
    web-mkdir /var/lib/unit
    web-chown fix /var/lib/unit /var/log/unit /run/unit

    if [[ -d /var/lib/unit/conf.json ]]; then
        return 0
    fi

    "$unitd_bin" --control "unix:$unit_socket"
    TIMEOUT=10 wait-for "$unit_socket" configtest

    local cert_path="/etc/ssl/site/server_${PHP_POOL_NAME:-www}.pem"
    if ls /etc/ssl/site/*.crt &>/dev/null && ls /etc/ssl/site/*.key &>/dev/null; then
        cat /etc/ssl/site/*.crt /etc/ssl/site/*.key > "$cert_path"
        unit-conf "$cert_path" "certificates/default"
    fi

    find /etc/unit/sites-enabled -type f -name "*.json" | sort -dbfi | while read -r json; do
        unit-conf "$json"
    done

    if is-debug; then
        configtest >&2
    fi

    if [[ -f "$unit_pid_file" ]]; then
        local unit_pid
        unit_pid="$(cat "$unit_pid_file")"
        kill -TERM "$unit_pid" &>/dev/null || true
        \rm -f "$unit_pid_file"
    fi

    attempts=0
    while [[ -f "$unit_socket" && "$attempts" -lt 20 ]]; do
        sleep 0.5
        ((attempts++))
    done
}

if is-debug; then
    debug-echo -w "🐞 Nginx Unit is in DEBUG MODE 🐞"
    init_unit || true
else
    init_unit &>/dev/null || true
fi
