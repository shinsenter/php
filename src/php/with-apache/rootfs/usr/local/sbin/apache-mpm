#!/usr/bin/env bash
################################################################################
#     These setups are part of the project: https://code.shin.company/php
#     Please respect the intellectual effort that went into creating them.
#     If you use or copy these ideas, proper credit would be appreciated.
#      - Author:  Mai Nhut Tan <shin@shin.company>
#      - License: https://code.shin.company/php/blob/main/LICENSE
################################################################################
config="${1:-/etc/apache2/mods-enabled/mpm_tuning.conf}"
profile="${2:-balanced}"

cpu_cores=$(grep -c ^processor /proc/cpuinfo)
ram_mb=$(free -m | awk '/^Mem:/{print $2}')

if ! has-cmd apache2; then
    echo "Error: apache2 command not found" >&2
    exit 1
fi

if apache2 -M 2>/dev/null | grep -qF -- mpm_prefork; then
    mpm_module='prefork'
else
    mpm_module='event'
fi

# === hệ số điều chỉnh theo profile ===
case "$profile" in
  low)
    factor_start=1
    factor_spare=1
    factor_clients=0.5
    ;;
  high)
    factor_start=5
    factor_spare=4
    factor_clients=2
    ;;
  balanced|*)
    factor_start=2
    factor_spare=2
    factor_clients=1
    ;;
esac

if [ "$mpm_module" = "prefork" ]; then
    start_servers=$((cpu_cores * factor_start))
    min_spare_servers=$((cpu_cores * factor_spare))
    max_spare_servers=$((cpu_cores * factor_spare * 2))
    max_clients=$(awk "BEGIN {printf \"%d\", $ram_mb / 10 * $factor_clients}")
    max_requests_per_child=1000

    cat <<EOF > "$config"
<IfModule mpm_${mpm_module}_module>
    ServerLimit 20000
    StartServers $start_servers
    MinSpareServers $min_spare_servers
    MaxSpareServers $max_spare_servers
    MaxRequestWorkers $max_clients
    MaxConnectionsPerChild $max_requests_per_child
</IfModule>
EOF

else
    start_servers=$((cpu_cores * factor_start))
    min_spare_threads=$((cpu_cores * factor_spare * 5))
    max_spare_threads=$((cpu_cores * factor_spare * 10))
    threads_per_child=25
    max_clients=$(awk "BEGIN {printf \"%d\", $ram_mb / 10 * $factor_clients / $threads_per_child * $threads_per_child}")

    cat <<EOF > "$config"
<IfModule mpm_${mpm_module}_module>
    ServerLimit 20000
    StartServers $start_servers
    MinSpareThreads $min_spare_threads
    MaxSpareThreads $max_spare_threads
    ThreadsPerChild $threads_per_child
    MaxRequestWorkers $max_clients
    MaxConnectionsPerChild 0
</IfModule>
EOF
fi
